name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  terraform:
    name: Terraform Infrastructure
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: hashicorp/setup-terraform@v2
      with:
        terraform_wrapper: false

    - uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-central-1

    - name: Terraform Init
      run: |
        cd terraform
        terraform init

    - name: Terraform Apply
      run: |
        cd terraform
        terraform apply -auto-approve

    - name: Get Server IP
      id: get-ip
      run: |
        cd terraform
        echo "server_ip=$(terraform output -raw server_ip)" >> $GITHUB_OUTPUT

    outputs:
      server_ip: ${{ steps.get-ip.outputs.server_ip }}

  deploy:
    name: Deploy Application
    needs: terraform
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Deploy to EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_IP: ${{ needs.terraform.outputs.server_ip }}
      run: |
        echo "$SSH_PRIVATE_KEY" | tr -d '\r' > bank
        chmod 600 bank
        
        sleep 60
        
        scp -i bank -o StrictHostKeyChecking=no -r . ubuntu@$SERVER_IP:/home/ubuntu/banking
        
        ssh -i bank -o StrictHostKeyChecking=no ubuntu@$SERVER_IP << 'ENDSSH'
        cd /home/ubuntu/banking
        docker-compose down || true
        docker-compose up -d --build
        ENDSSH